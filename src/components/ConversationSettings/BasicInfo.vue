<!--
  - SPDX-FileCopyrightText: 2023 Nextcloud GmbH and Nextcloud contributors
  - SPDX-License-Identifier: AGPL-3.0-or-later
-->

<template>
	<h4 class="app-settings-section__subtitle">
		{{ t('spreed', 'Name') }}
	</h4>
	<EditableTextField :editable="canFullModerate"
		:initial-text="conversationName"
		:editing="isEditingName"
		:loading="isNameLoading"
		:placeholder="t('spreed', 'Enter a name for this conversation')"
		:edit-button-aria-label="t('spreed', 'Edit conversation name')"
		:max-length="CONVERSATION.MAX_NAME_LENGTH"
		@submit-text="handleUpdateName"
		@update:editing="handleEditName" />
	<template v-if="!isOneToOne">
		<h4 class="app-settings-section__subtitle">
			{{ t('spreed', 'Description') }}
		</h4>
		<EditableTextField :editable="canFullModerate"
			:initial-text="description"
			:editing="isEditingDescription"
			:loading="isDescriptionLoading"
			:edit-button-aria-label="t('spreed', 'Edit conversation description')"
			:placeholder="t('spreed', 'Enter a description for this conversation')"
			:max-length="CONVERSATION.MAX_DESCRIPTION_LENGTH"
			multiline
			use-markdown
			@submit-text="handleUpdateDescription"
			@update:editing="handleEditDescription" />
	</template>
	<template v-if="supportsAvatar">
		<h4 class="app-settings-section__subtitle">
			{{ t('spreed', 'Picture') }}
		</h4>
		<ConversationAvatarEditor :conversation="conversation"
			:editable="canFullModerate" />
	</template>
</template>

<script>
import { getCapabilities } from '@nextcloud/capabilities'
// eslint-disable-next-line
// import { showError } from '@nextcloud/dialogs'

import ConversationAvatarEditor from './ConversationAvatarEditor.vue'
import EditableTextField from '../UIShared/EditableTextField.vue'

import { CONVERSATION } from '../../constants.js'

const supportsAvatar = getCapabilities()?.spreed?.features?.includes('avatar')

export default {
	name: 'BasicInfo',

	components: {
		EditableTextField,
		ConversationAvatarEditor,
	},

	props: {
		conversation: {
			type: Object,
			required: true,
		},

		canFullModerate: {
			type: Boolean,
			required: true,
		},
	},

	setup() {
		return {
			supportsAvatar,
			CONVERSATION,
		}
	},

	data() {
		return {
			isEditingDescription: false,
			isDescriptionLoading: false,
			isEditingName: false,
			isNameLoading: false,
		}
	},

	computed: {
		isOneToOne() {
			return this.conversation.type === CONVERSATION.TYPE.ONE_TO_ONE
				|| this.conversation.type === CONVERSATION.TYPE.ONE_TO_ONE_FORMER
		},

		conversationName() {
			return this.conversation.displayName
		},

		description() {
			return this.conversation.description
		},

		token() {
			return this.conversation.token
		},
	},

	methods: {
		async handleUpdateName(name) {
			this.isNameLoading = true
			try {
				await this.$store.dispatch('setConversationName', {
					token: this.token,
					name,
				})
				this.isEditingName = false
			} catch (error) {
				console.error('Error while setting conversation name', error)
				window.OCP.Toast.error(t('spreed', 'Error while updating conversation name'))
			}
			this.isNameLoading = false
		},

		handleEditName(payload) {
			this.isEditingName = payload
		},

		async handleUpdateDescription(description) {
			this.isDescriptionLoading = true
			try {
				await this.$store.dispatch('setConversationDescription', {
					token: this.token,
					description,
				})
				this.isEditingDescription = false
			} catch (error) {
				console.error('Error while setting conversation description', error)
				window.OCP.Toast.error(t('spreed', 'Error while updating conversation description'))
			}
			this.isDescriptionLoading = false
		},

		handleEditDescription(payload) {
			this.isEditingDescription = payload
		},
	},
}
</script>

<style lang="scss" scoped>

</style>
